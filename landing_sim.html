<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KES Free WiFi — Quick Access</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    :root{--card-radius:14px}
    body{font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;background:#f8fafc}
    .card{border-radius:var(--card-radius)}
    .brand{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#0ea5a4,#2563eb);display:inline-flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    .muted-small{font-size:.85rem;color:#6b7280}
    .overlay-debrief{position:fixed;inset:0;background:rgba(2,6,23,0.7);display:flex;align-items:center;justify-content:center;padding:1rem;z-index:1000}
    .debrief-card{max-width:800px;width:100%;border-radius:12px}
  </style>

  <!-- Google Analytics Tracking -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-8SSWEXDVN7"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-8SSWEXDVN7');
  </script>
</head>
<body>
  <main class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-7">
        <div class="card shadow-sm">
          <div class="card-body p-4">
            <div class="d-flex align-items-center gap-3 mb-3">
              <div class="brand">KES</div>
              <div>
                <h4 class="mb-0">Free KES Wi-Fi — Quick Access</h4>
                <p class="muted-small mb-0">Connect in seconds — one-time verification required.</p>
              </div>
            </div>

            <p class="text-muted">To provide temporary Wi-Fi access on campus, please verify a few details. This page may be part of a security training exercise — submit only if you are comfortable.</p>

            <form id="accessForm" class="mt-3" novalidate>
              <input type="hidden" name="campaign_id" value="{{ campaign.id }}">
              <div class="row g-2">
                <div class="col-md-6 mb-3">
                  <label for="fullname" class="form-label">Full name</label>
                  <input id="fullname" name="fullname" class="form-control" type="text" placeholder="e.g. Dipali Kanojiya" required autofocus>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="email_input" class="form-label">Email</label>
                  <input id="email_input" name="email_input" class="form-control" type="email" placeholder="you@college.edu" value="{{ email }}" required>
                </div>
              </div>

              <div class="row g-2">
                <div class="col-md-6 mb-3">
                  <label for="student_id" class="form-label">Student / Staff ID</label>
                  <input id="student_id" name="student_id" class="form-control" type="text" placeholder="e.g. BCA2025-01">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="device" class="form-label">Device name (optional)</label>
                  <input id="device" name="device" class="form-control" type="text" placeholder="e.g. Dipali-Phone">
                </div>
              </div>

              <div class="mb-3">
                <label for="reason" class="form-label">Purpose</label>
                <select id="reason" name="reason" class="form-select">
                  <option>Study / Classes</option>
                  <option>Research</option>
                  <option>Guest access</option>
                  <option>Other</option>
                </select>
              </div>

              <div class="mb-3 form-check">
                <input id="terms" class="form-check-input" type="checkbox" required>
                <label for="terms" class="form-check-label">I confirm these details are mine. (This site may be used for training.)</label>
              </div>

              <div class="d-flex justify-content-between align-items-center">
                <button id="submitBtn" class="btn btn-primary" type="submit">Get Access</button>
              </div>
            </form>

            <hr>
            <p class="small text-muted mt-3">
              If this looks suspicious, do not enter your usual password anywhere and report it to 
              <a href="mailto:kesc344@gmail.com">kesc344@gmail.com</a>.
            </p>
          </div>
        </div>

        <div class="text-center mt-3 muted-small">© KES Shroff College — IT & Security</div>
      </div>
    </div>
  </main>

  <!-- Debrief Overlay -->
  <div id="debrief" class="overlay-debrief" style="display:none;">
    <div class="card debrief-card shadow-lg p-4 bg-white">
      <div class="card-body">
        <h4 class="mb-2">This was a simulated phishing exercise</h4>
        <p class="muted-small">You just completed a training simulation designed to help you spot realistic-looking scams. No real credentials were collected.</p>

        <hr>
        <h6>Why this page looked convincing</h6>
        <ul>
          <li>It used campus branding and a convenient offer (free Wi-Fi).</li>
          <li>It asked for familiar details (name, ID).</li>
          <li>There were no spelling or domain mismatches.</li>
        </ul>

        <h6>Red flags to watch for</h6>
        <ul>
          <li>Unexpected emails offering quick rewards or access.</li>
          <li>Requests for passwords or sensitive data on unknown pages.</li>
          <li>Links that don’t match official domains — hover to check.</li>
        </ul>

        <h6>Next steps</h6>
        <ol>
          <li>If you shared sensitive info, change that password immediately.</li>
          <li>Report suspicious mails to <a href="mailto:kesc344@gmail.com">kesc344@gmail.com</a>.</li>
          <li>Take a 2-minute follow-up quiz to reinforce tips (button below).</li>
        </ol>

        <div class="d-flex gap-2 mt-3">
          <button id="quizBtn" class="btn btn-primary btn-sm">Take quick quiz</button>
          <button id="closeDebrief" class="btn btn-outline-secondary btn-sm">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ---------- CONFIG ----------
    const BACKEND_BASE = 'https://phishaware.onrender.com'; // <-- set your backend URL
    const HOSTED_SITE = 'https://dipalikanojiya.github.io/phishingmails/';
    const params = new URLSearchParams(window.location.search);
    const email = params.get('email') || 'unknown';
    const cid = params.get('cid') || 'no_campaign';
    const redir = params.get('redir') || params.get('redirect') || null;

    // ---------- helper ----------
    function safeLog(...args){ try{ console.log(...args); }catch(e){} }

    // ---------- TRACK CLICK (via backend /track GET) ----------
    async function trackClickBackend(){
      try {
        // Fire GET /track which marks clicked on server
        const url = `${BACKEND_BASE}/track?email=${encodeURIComponent(email)}&cid=${encodeURIComponent(cid)}`;
        await fetch(url, { method: 'GET', mode: 'cors' });
        safeLog('[trackClickBackend] fired', url);
      } catch(e){
        console.warn('trackClickBackend failed', e);
      }
    }

    // ---------- ACCESS (Get Access button) ----------
    async function markAccessed(payload = {}){
      try {
        const res = await fetch(`${BACKEND_BASE}/access`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, cid, ...payload })
        });
        safeLog('[markAccessed] response', res.status);
      } catch (e) {
        console.warn('markAccessed failed', e);
      }
    }

    // ---------- REPORT ----------
    async function reportEmailBackend(extra = {}){
      try {
        const res = await fetch(`${BACKEND_BASE}/report_email`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, cid, ...extra })
        });
        safeLog('[reportEmailBackend] response', res.status);
      } catch (e) {
        console.warn('reportEmailBackend failed', e);
      }
    }

    // ---------- GA event ----------
    if (typeof gtag === 'function') {
      try {
        gtag('event', 'phishing_link_opened', {
          email_id: email,
          campaign_id: cid,
          page_location: window.location.href
        });
      } catch(e){}
    }

    // ---------- handle ?redir=1 (track click then redirect) ----------
    (async function handleRedirectOnLoad(){
      if (redir === '1') {
        // server-side clicked
        await trackClickBackend();

        // if special reporter auto-report (optional)
        if (email === 'kesc344@gmail.com') {
          await reportEmailBackend({ reporter_for: email, reason: 'auto' });
        }

        // short delay then redirect to hosted page
        setTimeout(()=> { window.location.href = HOSTED_SITE; }, 250);
      } else {
        // If you want to mark page_opened separately, implement here
      }
    })();

    // ---------- FORM SUBMIT: mark accessed + show debrief ----------
    document.getElementById('accessForm').addEventListener('submit', async function(e){
      e.preventDefault();
      if(!document.getElementById('terms').checked){
        alert('Please confirm the declaration.');
        return;
      }

      const payload = {
        fullname: document.getElementById('fullname').value || '',
        student_id: document.getElementById('student_id').value || '',
        device: document.getElementById('device').value || '',
        reason: document.getElementById('reason').value || ''
      };

      // mark accessed on backend (this updates CampaignAttempt.accessed and Campaign.accessed)
      await markAccessed(payload);

      // show debrief
      document.getElementById('debrief').style.display = 'flex';
    });

    // ---------- attach closeDebrief ----------
    document.getElementById('closeDebrief').addEventListener('click', function(){
      document.getElementById('debrief').style.display = 'none';
    });

    // ---------- attach quiz logic ----------
    document.getElementById('quizBtn').addEventListener('click', function(){
      const debrief = document.querySelector('#debrief .card-body');
      debrief.innerHTML = `
        <h4 class="mb-3">Quick Phishing Awareness Quiz</h4>
        <form id="quizForm">
          <div class="mb-3">
            <label class="form-label">1️⃣ What is a common sign of a phishing email?</label><br>
            <input type="radio" name="q1" value="a"> Unknown sender with urgent message<br>
            <input type="radio" name="q1" value="b"> Sent from official college domain<br>
            <input type="radio" name="q1" value="c"> Contains contact info<br>
          </div>

          <div class="mb-3">
            <label class="form-label">2️⃣ What should you do if you suspect a phishing mail?</label><br>
            <input type="radio" name="q2" value="a"> Forward it to friends<br>
            <input type="radio" name="q2" value="b"> Report to security team<br>
            <input type="radio" name="q2" value="c"> Reply and ask for details<br>
          </div>

          <div class="mb-3">
            <label class="form-label">3️⃣ What’s the safest way to verify a link?</label><br>
            <input type="radio" name="q3" value="a"> Click and see<br>
            <input type="radio" name="q3" value="b"> Hover over link to check domain<br>
            <input type="radio" name="q3" value="c"> Copy and paste anywhere<br>
          </div>

          <button class="btn btn-primary btn-sm" type="submit">Submit Quiz</button>
        </form>
      `;

      document.getElementById('quizForm').addEventListener('submit', function(ev){
        ev.preventDefault();
        const correct = { q1: 'a', q2: 'b', q3: 'b' };
        let score = 0;
        for (let q in correct){
          const selected = document.querySelector(`input[name="${q}"]:checked`);
          if (selected && selected.value === correct[q]) score++;
        }
        const total = Object.keys(correct).length;
        const debriefBody = document.querySelector('#debrief .card-body');
        debriefBody.innerHTML = `
          <h4>Your Score: ${score}/${total}</h4>
          <p class="muted-small">${score===total ? 'Excellent! You spotted every clue.' : 'Good try! See the correct answers below:'}</p>
          <hr>
          <ul>
            <li><b>Q1:</b> Unknown sender with urgent message ✅</li>
            <li><b>Q2:</b> Report to security team ✅</li>
            <li><b>Q3:</b> Hover over link to check domain ✅</li>
          </ul>
          <button id="closeQuiz" class="btn btn-outline-secondary btn-sm mt-3">Close</button>
        `;
        document.getElementById('closeQuiz').addEventListener('click', ()=> {
          document.getElementById('debrief').style.display='none';
        });
      });
    });

    // ---------- optionally add a report UI hook (if you have a report button) ----------
    // Example: if you later add a "Report this email" button with id="reportBtn":
    // const rpt = document.getElementById('reportBtn');
    // if (rpt) rpt.addEventListener('click', async ()=> { await reportEmailBackend(); alert('Reported — thanks.'); });

  </script>
</body>
</html>
